<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Gestalt Experiment</title>
  <script src="/static/js/jspsych/dist/jspsych.js"></script>
  <script src="/static/js/jspsych/dist/plugin-preload.js"></script>
  <script src="/static/js/jspsych/dist/plugin-instructions.js"></script>
  <script src="/static/js/jspsych/dist/plugin-survey-text.js"></script>
  <script src="/static/js/jspsych/dist/plugin-external-html.js"></script>
  <script src="/static/js/plugin-probe-detection-task.js"></script>
  <script src="/static/js/jquery/dist/jquery.min.js"></script>
  <script src="/static/js/consent.js"></script>
  <link rel="stylesheet" href="/static/css/styles.css" />
  <link href="/static/js/jspsych/dist/jspsych.css" rel="stylesheet" type="text/css" />
</head>

<body class="jspsych-content-wrapper jspsych-display-element" tabindex="0"
  style="margin: 0px; height: 100%; width: 100%;">
  <div class="jspsych-content-wrapper">
    <div id="jspsych-content" class="jspsych-content">
      <div style="margin: 50px 0 0 -50px">
        Please wait momentarily while the experiment loads...
      </div>
      <div id="loader">
        <div id="shadow"></div>
        <div id="box"></div>
      </div>
    </div>
</body>
<script>
  const jsPsych = initJsPsych({
    show_progress_bar: true,
    auto_update_progress_bar: true,
  });

  $.ajax({
    type: "GET",
    url: "/get_trial_data",
    data: { experiment: "detection", domain: "static" },
    dataType: "json",
    success: function (resp) {
      trials = [];
      var preload = {
        type: jsPsychPreload,
        auto_preload: true,
        on_start: function () {
          document.body.style.backgroundColor = "#fff";
        }
      };
      trials.push(preload);

      consent = {
        type: jsPsychExternalHtml,
        url: "consent.html",
        cont_btn: "start",
      }
      trials.push(consent);

      const instructions = {
        type: jsPsychInstructions,
        pages: ["Welcome to our experiment! To continue reading the instructions please hit the right arrow key.",

          "In this experiment, you will be asked to determine whether or not a red dot is touching an object. \
                  During the experiment, objects will be camouflaged against the background. The objects in question are simple, 3D shapes, \
                  and when they're not camouflaged, look like these shapes: <br><br> \
                  <img height=450, width=800, src='https://gestalt-scenes.s3.us-east-2.amazonaws.com/experiment_media/all_stims.gif'></img>",

          "Objects can appear anywhere in a scene. If the center (red part) of a dot is touching an object, click 'Yes', and draw a box around \
                  visible part of the object it is touching. For example, on the example trial below, the dot is touching an object so the answer is 'Yes'. \
                  <br> <br>After clicking yes, we can draw a box around that object, and hit 'Submit' to continue. You can redraw a bounding box to adjust it as many times as you want before continuing. While it doesn't need to be perfect, try and make the box you draw fit the object (ie; try not to leave too much space on the outside). Sometimes an object isn't fully visible, like if it's blocked by another object in front of it. In those cases, just draw a box around the visible portion of the object that the dot is touching. \
                  <br><br> \
                  <video src='https://gestalt-scenes.s3.us-east-2.amazonaws.com/experiment_media/example_trial.mp4' type='video/mp4' width=500, height=500 controls autoplay> \
                    </video>",

          "In the example below, the dot is not touching an object, so we can simply click 'No' and move on  \
          <br><br> \
          <video src = 'https://gestalt-scenes.s3.us-east-2.amazonaws.com/experiment_media/gestalt-example-no-trial.mov' type = 'video/mov' width = 500, height = 500 controls autoplay >",
          "Ready? The experiment will start on the next page. To review any of the instructions, just hit the back arrow to return to a previous page.",
        ],
        show_clickable_nav: true
      };

      trials.push(instructions);
      console.log(resp.user_id)
      data = resp.data;
      completion_code = resp.completion_code;

      for (let i = 0; i < data.length; i++) {
      	if (i == Math.floor(data.length / 2)) {
           var progress_trial = {
             type: jsPsychInstructions,
             pages: ["You're halfway through the experiment! Great job so far!"],
             show_clickable_nav: true,
	     button_label_next: "Continue",
	     allow_backward: false
           }
           trials.push(progress_trial);
         }

        const trial = {
          type: jsPsychProbeDetectionTask,
          stimulus: data[i].image_url,
          stimulus_index: (data[i].frame_idx, data[i].mask_idx),
          probe_location: data[i].probe_location,
          probe_touching: data[i].probe_touching,
          bounding_box: data[i].bounding_box,
          experiment_type: "detection",
          domain: "static",
          batch: 0,
          on_finish: function (response_data) {
            trial_data = { ...response_data, ...data[i] }
            $.ajax({
              type: "POST",
              url: "/post_data",
              contentType: 'application/json;charset=UTF-8',
              data: JSON.stringify({
                trial_data: trial_data,
                user_id: resp.user_id,
                experiment: "detection",
                domain: "static",
                batch: 0,
                db_name: "psychophys",
                col_name: "test"
              }),
              dataType: "json",
              success: function (resp) {
                console.log(resp);
              },
            })
          }
        };
        trials.push(trial);
      }

      var comments_block = {
        type: jsPsychSurveyText,
        preamble:
          '<p>Thank you for participating in our study.</p><p><strong>Click "Finish" to complete the experiment and receive compensation.</strong> If you have any comments, please let us know in the form below.</p>',
        questions: [{ prompt: "Do you have any comments to share with us?" }],
        button_label: "Finish",
        on_finish: function () {
          document.body.innerHTML =
            "<p> Please wait. You will be redirected back to Prolific in a few moments.</p> If not, please use the following completion code to ensure \
            compensation for this study: 6713F83E";
          setTimeout(function () {
            location.href =
              "https://app.prolific.co/submissions/complete?cc=6713F83E"  // add correct completion code
          }, 500);
          sendData();
        },
      };

      // finished_trial = {
      //   type: jsPsychInstructions,
      //   pages: ["Thank you for participating in this study!"
      //     + " Please copy the completion code below or click "
      //     + " <a href='https://app.prolific.co/submissions/complete?cc=6713F83E' target='_blank'> here to complete the experiment.</a>" +
      //     "<p><strong>Completion Code: </strong> 6713F83E</p>"]
      // }
      trials.push(comments_block)


      jsPsych.run(trials);
    },
  });
</script>

</html>
